---
title: "EJ_Data_Exploration"
author: "Mario"
date: "7/2/2019"
output: html_document
---

```{r setup, include=FALSE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}

#library load

library(tidyverse)
library(sf)
library(leaflet)
library(tmap)
library(raster)
library(maptools)
library(rgdal)



```


```{r}

#read in CalEnvironScreen June 2018 shapefile

ces_shapefile <- st_read(dsn = "CalEnvironScreen/CESJune2018Update_SHP", layer = "CES3June2018Update")


#read column names for shapefile
colnames(ces_shapefile)


```

###CIScore Percent

```{r}

#set tmap as interactive mode
tmap_mode("view")

#read in visual for CalEnvironScreen with polygons set the CalEnvironScreen Score (Pollution Burden * Population Characteristics) AS PERCENTILE
tm_shape(ces_shapefile) +
  tm_polygons("CIscoreP") 

```

###Poverty Percent

```{r}


tmap_mode("view")
#read in visual for CalEnvironScreen with polygons set the POVERTY level AS PERCENTILE
tm_shape(ces_shapefile) +
  tm_polygons("povP")

```


###Along Racial Lines (Percent by Census Tract)

```{r}

tmap_mode("view")

#read in visual for CalEnvironScreen with polygons set the Race_PERCENTILE by Census Tract
tm_shape(ces_shapefile) +
  tm_polygons(c("Hispanic_p", "White_pct",  "African_Am", "Native_Ame", "Asian_Amer", "Other_pct")) +
  tm_facets(sync = TRUE) +
  tmap_options(limits = c(facets.view = 6))


```




```{r}

#read in fracking data as csv data.frame
ASTABLE_well_location <- read.csv("Well_Data/AllWells_table/AllWells_20190724.csv")

#convert table to spatial data
ASSPATIAL_well_location <- st_as_sf(ASTABLE_well_location, coords = c("Longitude", "Latitude"), crs = 4326)

#filter out only Oil and Gas Wells (OG) and ACTIVE wells
ACTIVE_well_location <- ASSPATIAL_well_location %>%
  filter(WellType == "OG" & WellStatus == "Active") 

#filter out only Oil and Gas Wells (OG) and NEW wells (Recently permitted well; in the process of being drilled)
NEW_well_location <- ASSPATIAL_well_location %>% 
  filter(WellType == "OG" & WellStatus == "New") 
             

```



```{r}

#display ACTIVE well location as clusters across CA
leaflet(data = ACTIVE_well_location) %>% 
  addTiles() %>% 
  addMarkers(clusterOptions = markerClusterOptions())

```


```{r}

#display NEW well location as clusters across CA
leaflet(data = NEW_well_location) %>% 
  addTiles() %>% 
  addMarkers(clusterOptions = markerClusterOptions())



```


##Find number of NEW well locations in specific tracts

```{r}


#using st_intersection function 
#https://gis.stackexchange.com/questions/110117/counting-number-of-points-in-polygon-using-r

#set CES and NEW_Well location as st objects
ces <- ces_shapefile

new_well <- st_as_sf(NEW_well_location)

#reset CRS for both to match (just to make sure)
ces2 = st_transform(ces, 4326)

new_well2 = st_transform(new_well, 4326)



#use st_intersect to get instersection of points (new_well) in polygons (ces).

### Allison notes: this is confusing to me... aren't both ces here (just has a latitude & longitude coordinate for each row, so aren't these just spatial points) and new_well locations both spatial points? Then trying to find an intersection doesn't make sense. Intersection works when trying to find points within a polygon.

NEW_intersect <- st_intersection(ces2, new_well2)


#subset count of well locations in polygons

# So if there are no intersections because they're both spatial points, then NEW_intersection might only contain the one place where both a well location and the ces location point are exactly the same (but either way, it doesn't really make sense to try to find intersections between two sets of spatial points)...

# Which means that this won't work how you want it to. 

int_results <- NEW_intersect %>% 
  group_by(tract) %>% 
  count()

as.data.frame(int_results)[,-3]



```


